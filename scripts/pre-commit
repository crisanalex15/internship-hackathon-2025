#!/bin/bash
#
# Pre-commit hook pentru AI Code Review
# Acest script ruleazÄƒ automat Ã®nainte de fiecare commit È™i trimite
# modificÄƒrile cÄƒtre serviciul AI pentru review
#

echo "ğŸ” Rulare AI Code Review..."

# VerificÄƒ dacÄƒ existÄƒ fiÈ™iere staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… Niciun fiÈ™ier modificat pentru review."
    exit 0
fi

# ObÈ›ine diff-ul complet al fiÈ™ierelor staged
GIT_DIFF=$(git diff --cached)

if [ -z "$GIT_DIFF" ]; then
    echo "âœ… Niciun diff pentru review."
    exit 0
fi

# URL-ul backend-ului API (modificÄƒ dacÄƒ este necesar)
API_URL="${AI_REVIEW_API_URL:-http://localhost:5000/api/aireview}"
JWT_TOKEN="${AI_REVIEW_JWT_TOKEN}"

# VerificÄƒ dacÄƒ token-ul JWT este setat
if [ -z "$JWT_TOKEN" ]; then
    echo "âš ï¸  AI Review: JWT_TOKEN nu este setat."
    echo "   SeteazÄƒ variabila de mediu AI_REVIEW_JWT_TOKEN pentru a activa review-ul automat."
    echo "   Exemplu: export AI_REVIEW_JWT_TOKEN='your-jwt-token'"
    echo "   Sau dezactiveazÄƒ hook-ul cu: git commit --no-verify"
    exit 0
fi

# CreeazÄƒ fiÈ™ier temporar cu diff-ul
TEMP_FILE=$(mktemp)
echo "$GIT_DIFF" > "$TEMP_FILE"

# PregÄƒteÈ™te JSON payload
JSON_PAYLOAD=$(jq -n \
    --arg gitDiff "$GIT_DIFF" \
    --arg fileName "staged changes" \
    '{gitDiff: $gitDiff, fileName: $fileName}')

# Trimite cerere cÄƒtre API
RESPONSE=$(curl -s -X POST "$API_URL" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $JWT_TOKEN" \
    -d "$JSON_PAYLOAD")

# CurÄƒÈ›Äƒ fiÈ™ierul temporar
rm -f "$TEMP_FILE"

# VerificÄƒ dacÄƒ API-ul a rÄƒspuns
if [ -z "$RESPONSE" ]; then
    echo "âš ï¸  AI Review: Nu s-a putut conecta la API (verifica dacÄƒ backend-ul ruleazÄƒ)"
    echo "   Continuarea commit-ului fÄƒrÄƒ review..."
    exit 0
fi

# Parse rÄƒspunsul JSON
SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
FINDINGS_COUNT=$(echo "$RESPONSE" | jq -r '.findings | length // 0')

if [ "$SUCCESS" != "true" ]; then
    ERROR_MSG=$(echo "$RESPONSE" | jq -r '.errorMessage // "Unknown error"')
    echo "âš ï¸  AI Review: Eroare la procesare - $ERROR_MSG"
    echo "   Continuarea commit-ului..."
    exit 0
fi

echo "âœ… AI Review finalizat: $FINDINGS_COUNT probleme gÄƒsite"

# VerificÄƒ dacÄƒ existÄƒ probleme critice sau de severitate Ã®naltÄƒ
CRITICAL_COUNT=$(echo "$RESPONSE" | jq -r '[.findings[] | select(.severity == "critical" or .severity == "high")] | length')

if [ "$CRITICAL_COUNT" -gt 0 ]; then
    echo ""
    echo "âŒ COMMIT BLOCAT: GÄƒsite $CRITICAL_COUNT probleme critice/majore!"
    echo ""
    echo "Probleme gÄƒsite:"
    echo "$RESPONSE" | jq -r '.findings[] | select(.severity == "critical" or .severity == "high") | "  - [\(.severity | ascii_upcase)] \(.file):\(.lineStart)-\(.lineEnd): \(.message)"'
    echo ""
    echo "Te rugÄƒm sÄƒ remediezi problemele critice Ã®nainte de commit."
    echo "Sau foloseÈ™te --no-verify pentru a bypassa acest check (nerecomandat)."
    echo ""
    exit 1
fi

# AfiÈ™eazÄƒ problemele gÄƒsite (non-blocking)
if [ "$FINDINGS_COUNT" -gt 0 ]; then
    echo ""
    echo "âš ï¸  AtenÈ›ie: GÄƒsite probleme non-critice:"
    echo "$RESPONSE" | jq -r '.findings[] | "  - [\(.severity | ascii_upcase)] \(.file):\(.lineStart)-\(.lineEnd): \(.message)"'
    echo ""
    echo "Commit-ul va continua, dar te rugÄƒm sÄƒ revizuieÈ™ti aceste probleme."
    echo ""
fi

echo "âœ… Pre-commit AI Review complet!"
exit 0

